<html>
	<script type="text/javascript" src="jquery-1.7.2.min.js"></script>
	<script src="bookmarks.js"></script>
  <script>
    function log(message, tab) {
      if(tab) {
        message = "[" + tab.id + "] " + message
      } 
      console.log(message);
    }

    log("background page kicking in!");

		function getServer(){
      var server = "keepitfindit.com";
			var env = getOptions().env
			if (env === "development") {
        server = "localhost:9000";
				//assuming the default of developemnt if env is not set.
			}
			return server;
		}

    function getPicture(userInfo) {
      chrome.cookies.get({"url":"http://facebook.com", "name": "c_user"}, function(cookie){
        if (!cookie) {
          throw Error("Could not find the facebook cookie!");
        }
        userInfo["facebook_id"] = cookie.value;
        userInfo["picture"] = "https://graph.facebook.com/" + cookie.value + "/picture";
        postBookmarks(chrome.bookmarks.getTree);
      });
    }

    function postBookmarks(bookmarksSupplier) {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          log("[postBookmarks] xhr response:");
          log(xhr.responseText);
        }
      }
      bookmarksSupplier(function(bookmarks){bookmarksPoster(bookmarks, xhr)});
    }

		function bookmarksPoster(bookmarks, xhr) {
			log("bookmarks:");
      log(bookmarks);
      var json = {
        "bookmarks": bookmarks,
        "user_info": userInfo
      }
      var tosend = JSON.stringify(json);
      xhr.open("POST", 'http://'+getServer()+'/bookmarks/add', true);
      xhr.send(tosend);
    }

    var userInfo = {}
    getPicture(userInfo);
		getBookMarks();

  	function onRequest(request, sender, sendResponse) {
      var tab = sender.tab;
      log("on request with " + JSON.stringify(request), tab);
      log("executing request " + request.type, tab)
      if (request.type === "init_page") {
        initPage(request, sendResponse, tab);
      } else if(request.type === "get_keeps") {
        searchOnServer(request, sendResponse);
      } else if(request.type === "get_user_info") {
        sendResponse(userInfo);
      } else if(request.type === "add_bookmarks") {
        getBookMarks(function(bookmarks){addKeep(bookmarks, request, sendResponse)});
      } else if (request.type == "get_opt") {
        var opt = getOptions();
				sendResponse(opt);
			}
  	  // Return nothing to let the connection be cleaned up.
  	}

    function addKeep(bookmarks, request, sendResponse) {
			log("creating bookmark. private: " + request.private + " tile " + request.title);
      var parent = (request.private) ? bookmarks.private : bookmarks.public;
			log("parent bookmark is "+JSON.stringify(parent));
      var bookmark = {
        'parentId': parent.id, 
        'title': request.title, 
        'url': request.url
      };
      chrome.bookmarks.create(bookmark, function(created) {
        sendResponse(created);
				postBookmarks(function (poster) {poster([bookmark]);});
			});
    }

    function searchOnServer(request, sendResponse) {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          log("[searchOnServer] xhr response:");
          log(xhr.response);
          var searchResults = $.parseJSON(xhr.response);
          var maxRes = getOptions().maxRes;
          if (searchResults.length > maxRes) {
            searchResults = searchResults.slice(0, maxRes);
          }
          sendResponse(searchResults);
        }
      }
      term = request.query;
      facebookUser = userInfo["facebook_id"];
      var url = 'http://' + getServer() + '/bookmarks/search?term=' + term + '&facebookUser=' + facebookUser;
      log("url is the " + url);
      xhr.open("GET", url, true);
      xhr.send();
    }

    function initPage(request, sendResponse, tab) {
      if (request.isGoogle === true) {
        injectGoogleDiv(tab);
        sendResponse({message: "created"});
      } else if (request.isGoogle === false) {
        log("injecting hover: " + request, tab);
        chrome.tabs.executeScript(tab.id, {file:"hover.js"});
      } else {
        //we're going to switch it to log later on, lets fast fail now.
        throw Error("init page request does not have a valid 'isGoogle' value: " + request);
      }

    }

    function injectGoogleDiv(tab) {
      //chrome.bookmarks.getTree(function(tree){console.log(tree);})
      chrome.tabs.executeScript(tab.id, {code:"console.log('[keepit] tab: " + tab.id + "')"});      
      chrome.tabs.executeScript(tab.id, {file:"google_inject.js"});
    }
  	// Listen for the content script to send a message to the background page.
  	chrome.extension.onRequest.addListener(onRequest);

    function getOptions() {
      var env = localStorage["env"];
      console.log("env is "+env);
      if (env==null || env===undefined) {
        env = "production";
      }
      var maxResStr = localStorage["max_search_results"]
      if (!maxResStr) {
        maxResStr = 5;
      }
      var maxRes = Number(maxResStr);
      return {
        "env": env, 
        "maxRes": maxRes
      }
    }

  </script>
  <body>
  </body>
</html>
