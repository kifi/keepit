<html>
  <script type="text/javascript" src="jquery-1.7.2.min.js"></script>
  <script src="bookmarks.js"></script>
  <script src="URI.js"></script>
  <script>
    // Called when a message is passed.  We assume that the content script
    // wants to show the page action.

    // Dummy results
    var magicQueries = [
      {
        "query":"skydiving",
        "results": [{"count":"0","bookmark":{"externalId":"9201f549-5959-4389-8bd8-98739405b5e7","title":"The Scala Programming Language","url":"http://www.scala-lang.org"},"users":[{"externalId":"3ad31932-f3f9-4fe3-855c-3359051212e5","firstName":"Danny","lastName":"Blumenfeld","facebookId":"636721190"},{"externalId":"ae5d159c-5935-4ad5-b979-ea280cb6c7ba","firstName":"Eishay","lastName":"Smith","facebookId":"646386018"}],"score":9.240311622619629,"isMyBookmark":true,"isPrivate":false},{"count":"0","bookmark":{"externalId":"e4929eee-c4c1-4f50-b19f-7d1aad92f461","title":"Scala","url":"http://www.reddit.com/r/scala"},"users":[],"score":7.650095462799072,"isMyBookmark":true,"isPrivate":false},{"count":"0","bookmark":{"externalId":"25cb0d32-c654-4e78-85ca-e38f91d3fc33","title":"Scala (programming language) - Wikipedia, the free encyclopedia","url":"http://en.wikipedia.org/wiki/Scala_(programming_language)"},"users":[{"externalId":"ae5d159c-5935-4ad5-b979-ea280cb6c7ba","firstName":"Eishay","lastName":"Smith","facebookId":"646386018"}],"score":7.050191879272461,"isMyBookmark":true,"isPrivate":false},{"count":"0","bookmark":{"externalId":"0c6bf447-15f2-4527-91bb-11657fb11ab6","title":"Scala School","url":"http://twitter.github.com/scala_school/"},"users":[{"externalId":"3ad31932-f3f9-4fe3-855c-3359051212e5","firstName":"Danny","lastName":"Blumenfeld","facebookId":"636721190"},{"externalId":"ae5d159c-5935-4ad5-b979-ea280cb6c7ba","firstName":"Eishay","lastName":"Smith","facebookId":"646386018"}],"score":5.796542644500732,"isMyBookmark":true,"isPrivate":false},{"count":"0","bookmark":{"externalId":"dd13fed4-520d-4135-a77b-922821b09a72","title":"Manning: Scala in Depth","url":"http://www.manning.com/suereth/"},"users":[],"score":4.908035755157471,"isMyBookmark":true,"isPrivate":false},{"count":"0","bookmark":{"externalId":"31419d48-26fc-4882-9f77-6a884dddbf73","title":"Scalex | Scala documentation search engine","url":"http://scalex.org"},"users":[],"score":2.375737190246582,"isMyBookmark":true,"isPrivate":false}]
      },
      {
        "query":"roast chicken",
        "results": [{"count":"0","bookmark":{"externalId":"9201f549-5959-4389-8bd8-98739405b5e7","title":"The Scala Programming Language","url":"http://www.scala-lang.org"},"users":[{"externalId":"3ad31932-f3f9-4fe3-855c-3359051212e5","firstName":"Danny","lastName":"Blumenfeld","facebookId":"636721190"},{"externalId":"ae5d159c-5935-4ad5-b979-ea280cb6c7ba","firstName":"Eishay","lastName":"Smith","facebookId":"646386018"}],"score":9.240311622619629,"isMyBookmark":true,"isPrivate":false},{"count":"0","bookmark":{"externalId":"e4929eee-c4c1-4f50-b19f-7d1aad92f461","title":"Scala","url":"http://www.reddit.com/r/scala"},"users":[],"score":7.650095462799072,"isMyBookmark":true,"isPrivate":false},{"count":"0","bookmark":{"externalId":"25cb0d32-c654-4e78-85ca-e38f91d3fc33","title":"Scala (programming language) - Wikipedia, the free encyclopedia","url":"http://en.wikipedia.org/wiki/Scala_(programming_language)"},"users":[{"externalId":"ae5d159c-5935-4ad5-b979-ea280cb6c7ba","firstName":"Eishay","lastName":"Smith","facebookId":"646386018"}],"score":7.050191879272461,"isMyBookmark":true,"isPrivate":false},{"count":"0","bookmark":{"externalId":"0c6bf447-15f2-4527-91bb-11657fb11ab6","title":"Scala School","url":"http://twitter.github.com/scala_school/"},"users":[{"externalId":"3ad31932-f3f9-4fe3-855c-3359051212e5","firstName":"Danny","lastName":"Blumenfeld","facebookId":"636721190"},{"externalId":"ae5d159c-5935-4ad5-b979-ea280cb6c7ba","firstName":"Eishay","lastName":"Smith","facebookId":"646386018"}],"score":5.796542644500732,"isMyBookmark":true,"isPrivate":false},{"count":"0","bookmark":{"externalId":"dd13fed4-520d-4135-a77b-922821b09a72","title":"Manning: Scala in Depth","url":"http://www.manning.com/suereth/"},"users":[],"score":4.908035755157471,"isMyBookmark":true,"isPrivate":false},{"count":"0","bookmark":{"externalId":"31419d48-26fc-4882-9f77-6a884dddbf73","title":"Scalex | Scala documentation search engine","url":"http://scalex.org"},"users":[],"score":2.375737190246582,"isMyBookmark":true,"isPrivate":false}]
      }
    ];
    // End Dummy results

    function log(message) {
      console.log("[" + new Date().getTime() + "] ", message);
    }

    function UserHistory() {
      var HISTORY_SIZE = 200;
      this.history = new Array();
      this.add = function(uri) {
        log("adding " + uri + " to user history.");
        this.history.unshift(uri);
        if(history.length > HISTORY_SIZE) {
          history.pop();
        }
      }
      this.exists = function(uri) {
        log("current history:");
        log(this.history);

        for(var i=0;i<this.history.length;i++) {
          if(this.history[i] === uri) {
            log(uri + " already has been visited");
            return true;
          }
        }
        return false;
      }
    }

    var userHistory = new UserHistory();

    function error(exception, message) {
      debugger;
      var errMessage = exception.message;
      if(message) {
        errMessage = "[" + message + "] " + exception.message;
      }
      if (exception) {
        console.error(exception);
      }
      console.error(errMessage);
      console.error(exception.stack);
      alert("exception: " + exception.message);
    }

    log("background page kicking in!");

    function postBookmarks(bookmarksSupplier, bookmarkSource) {
      log("posging bookmarks...");
      try {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (xhr.readyState == 4) {
            log("[postBookmarks] xhr response:");
            log(xhr.responseText);
          }
        }
        bookmarksSupplier(function(bookmarks){
          try {
            bookmarksPoster(bookmarks, bookmarkSource, xhr);
          } catch (e) {
            error(e);
          }
        });
      } catch (e) {
        error(e);
      }
    }

    function bookmarksPoster(bookmarks, bookmarkSource, xhr) {
      log("bookmarks:");
      log(bookmarks);
      var json = {
        "bookmarks": bookmarks,
        "user_info": userInfo,
        "bookmark_source": bookmarkSource
      }
      var tosend = JSON.stringify(json);
      xhr.open("POST", 'http://' + getConfigs().server + '/bookmarks/add', true);
      xhr.send(tosend);
      log("posted bookmarks");
    }

    function onRequest(request, sender, sendResponse) {
      log("new request...");
      try {
        if(typeof request === 'undefined' || typeof request.type === 'undefined' ) {
          log("Recieved an unknown message. Discarding.");
          log(request);
          log(tab);
          return;
        }
        var tab = sender.tab;
        log("on request with " + JSON.stringify(request), tab);
        // Show the page action for the tab that the sender (content script) was on.
        log("executing request " + request.type, tab);
        if (request.type === "init_page") {
          initPage(request, sendResponse, tab);
        } else if(request.type === "get_keeps") {
          searchOnServer(request, sendResponse, tab);
        } else if(request.type === "get_user_info") {
          sendResponse(userInfo);
        } else if(request.type === "add_bookmarks") {
          getBookMarks(function(bookmarks) {
            addKeep(bookmarks, request, sendResponse, tab);
          });
        } else if (request.type == "get_conf") {
          var conf = getConfigs();
          sendResponse(conf);
        } else if (request.type == "set_conf") {
          setConfigs(request.key, request.value);
          sendResponse();
        } else if (request.type == "remove_conf") {
          setConfigs(request.key);
          sendResponse();
        } else if (request.type == "upload_all_bookmarks") {
          upload_all_bookmarks();
        }
        else if (request.type === "check_hover_existed") {
          if(request.kifi_hover === false) { addHover(tab.id); }
        }
        else if (request.type === "set_page_icon") {
          setPageIcon(tab.id, request.is_kept);
        }
        else if (request.type === "is_already_kept") {
          remoteIsAlreadyKept(request.location, sendResponse);
        }
        else if (request.type === "open_slider") {
          addHover(tab.id);
        }
        // Return nothing to let the connection be cleaned up.
      } catch (e) {
        error(e);
      }
      log("done request...");
    }

    function upload_all_bookmarks() {
      log("going to upload all my bookamrks to server");
      getPicture(userInfo);
      getKeepitId(userInfo)
    }

    function addKeep(bookmarks, request, sendResponse, tab) {
      log("creating bookmark. private: " + request.private + " tile " + request.title, tab);
      var parent = (request.private) ? bookmarks.private : bookmarks.public;
      var bookmark = {'parentId': parent.id, 'title': request.title, 'url': request.url};
      chrome.bookmarks.create(bookmark, function(created) {
        try {
          sendResponse(created);
          postBookmarks(function (poster) {poster([bookmark]);}, "HOVER_KEEP");
        } catch (e) {
          error(e);
        }
      });
    }

    function searchOnServer(request, sendResponse, tab) {

      // Dummy results injection
      for(i=0;i<magicQueries.length;i++) {
        if(magicQueries[i].query === request.query) {
          log("Intercepting query: " + request.query);
          sendResponse({"userInfo": userInfo, "searchResults": magicQueries[i].results});
          return;
        }
      }
      // Dummy results injection

      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          log("[searchOnServer] xhr response:", tab);
          log(xhr.response, tab);
          var searchResults = $.parseJSON(xhr.response);
          if (searchResults.length === 0) {
            return;
          }
          var maxRes = getConfigs()["max_res"];
          if (searchResults.length > maxRes) {
            searchResults = searchResults.slice(0, maxRes);
          }
          sendResponse({"userInfo": userInfo, "searchResults": searchResults});
        }
      }
      term = encodeURIComponent(request.query);
      var externalId = userInfo["keepit_external_id"];
      xhr.open("GET", 'http://' + getConfigs().server + '/search?term=' + term + '&externalId=' + externalId, true);
      xhr.send();
    }

    function catching(block) {
      try {
        block();
      } catch (e) {
        error(e);
      }
    }

    var restrictedUrlPatternsForHover = [
      "www.facebook.com",
      "keepitfindit.com",
      "ezkeep.com",
      "localhost:",
      "maps.google.com",
      "google.com*tbm=isch",
      "google.com"
    ]

    function initPage(request, sendResponse, tab) {
      try {
        log("init page!!!!!!!!");
        setPageIcon(tab.id, false);

        var restrictedElements = $.grep(restrictedUrlPatternsForHover, function(e, i){
          return request.location.indexOf(e) >= 0;
        });
        if (restrictedElements.length > 0) {
          log("restricted hover page: " + restrictedElements);
          return;
        }

        if (request.isGoogle === true) {
          log("init_page for Google pages");
        } else if (request.isGoogle === false) {

          var pageLocation = request.location;

          log("injecting hover: " + request, tab);
          var userConf =  getConfigs();
          var hoverTimeout = userConf["hover_timeout"];


          if(typeof userConf.user === "undefined" || typeof userConf.user.keepit_external_id === "undefined" || typeof userConf.user.facebook_id === "undefined") {
            // User does not have facebook configured.
            log("User does not have facebook configured.");
            openFacebookConnect();
            return;
          }

          remoteIsAlreadyKept(pageLocation, function(isKept) {
            if(isKept) {
              setPageIcon(tab.id, true);
              attachShortcut();
              log("hiding hover cause URL " + pageLocation + " already kept", tab);
              if(userHistory.exists(pageLocation) === true) {
                return;
              }

              userHistory.add(pageLocation);
            }
            else {
              setPageIcon(tab.id, false);
              attachShortcut();
              if(userHistory.exists(pageLocation) === true) {
                return;
              }

              userHistory.add(pageLocation);
              if (hoverTimeout > 0) {
                setTimeout(function() {
                  // For the auto-slide in, we check to see if the hover has existed on this page before.
                  checkHoverExisted(tab.id);
                }, hoverTimeout * 1000);
              }
            }
          });
        } else {
          throw Error("request isGoogle is not well defined: " + request.isGoogle);
        }
      } catch (e) {
        error(e);
      }
    }

    function attachShortcut(tabid) {
      safeExecuteScript(tabid, {
        code: "$(window).keydown(function(e) { if(e.metaKey && e.keyCode == 75) { chrome.extension.sendRequest({'type':'open_slider'}); } });"
      });
    }

    function checkHoverExisted(tabid) {
      safeExecuteScript(tabid, {
        code: "chrome.extension.sendRequest({'type': 'check_hover_existed', 'kifi_hover': typeof window.kifi_hover !== 'undefined'});"
      });
    }

    function safeExecuteScript(tabid, data, callback) {
      if(typeof tabid === 'undefined')
        return;
      chrome.tabs.get(tabid, function(tab) {
        if(typeof tab === 'undefined' || !tab) {
          log("tab " + tabid + " is already closed.")
          callback(null);
          return;
        }
        else {
          chrome.tabs.executeScript(tabid, data, callback);
        }
      });
    }


    function addHover(tabid) {
      chrome.tabs.sendRequest(tabid,{type:"show_hover"}, function(response) {
        log("Hover shown");
      });

    }

    function addHoverToTab(tab) {
      addHover(tab.id);
    }

    chrome.pageAction.onClicked.addListener(addHoverToTab);

    function isAlreadyKept(bms, location) {
      try {
        var found;
        $.each(bms, function(index, bm) {
          if (bm.url) {
            found = found || URI(location).equals(URI(bm.url));
          }
          else {
            found = found || ( bm.children && isAlreadyKept(bm.children, location));
          }
          return !found
        });
        return found;
      } catch (e) {
        error(e);
      }
    }

    function remoteIsAlreadyKept(location, callback) {
      log("checking if user has already bookmarked page: " + location)
      $.get("http://" + getConfigs().server + "/bookmarks/check?externalId=" + userInfo["keepit_external_id"] + "&uri=" + encodeURIComponent(location), null,
        function(data) {
          callback(data["user_has_bookmark"]) 
        },
        "json"
      ).error(function(error) {
        log(error.responseText);
        callback(false);
      });
    }

    function setPageIcon(tabId, is_kept) {
      try {
        if(typeof tabId === 'undefined') {
          return;
        }
        chrome.tabs.get(tabId, function(tab) {
          if(typeof tab === 'undefined' || !tab)
            return;
          if(is_kept === true) {
            chrome.pageAction.setIcon({"tabId":tabId, "path":"kept.png"});
          }
          else {
            chrome.pageAction.setIcon({"tabId":tabId, "path":"keepit.png"});
          }
          chrome.pageAction.show(tabId);
        });
      }  catch (e) { }
    }
    
    function injectGoogleDiv(tab) {
      log("injecting google_inject.js into tab", tab)
      try {
        safeExecuteScript(tab.id, {code:"console.log('[" + new Date().getTime() + "] (from injector) [keepit:google] tab: " + tab.id + "')"}, 
          function(vars){
            log("[callback] executed logging", tab);
        });
        safeExecuteScript(tab.id, {file:"google_inject.js"}, function(vars){
          log("[callback] executed google_inject.js", tab);
        });
        log("injected google_inject.js into tab", tab)
      } catch (e) {
        error(e);
      }
    }

    // Listen for the content script to send a message to the background page.
    chrome.extension.onRequest.addListener(onRequest);

    function getFullyQualifiedKey(key) {
      var env = localStorage["env"];
      if (!env) {
        env = "production";
      }
      var fullyQualifiedKey = env + "_" + key;
      log("fullyQualifiedKey for key is " + fullyQualifiedKey);
      return fullyQualifiedKey;
    }

    function removeFromConfigs(key) {
      localStorage.removeItem(getFullyQualifiedKey(key));
    }

    function setConfigs(key, value) {
      log("setting config key " + key + " with " + value + ", prev value is ", localStorage[getFullyQualifiedKey(key)]);
      localStorage[getFullyQualifiedKey(key)] = value;
    }

    function getConfigs() {
      try {
        var env = localStorage["env"];
        if (!env) {
          env = "production";
          localStorage["env"]=env;
        }
        var maxResStr = localStorage[getFullyQualifiedKey("max_search_results")];
        if (!isNumber(maxResStr)) {
          maxResStr = 5;
        }
        var maxRes = Number(maxResStr);

        var showScore = localStorage[getFullyQualifiedKey("show_score")];
        log("raw showScore is: " + showScore);
        if (showScore === "yes" || showScore === true || showScore === "true") {
          showScore = true;
        } else {
          showScore = false;
        }

        var hoverTimeout = localStorage[getFullyQualifiedKey("hover_timeout")];
        if (typeof hoverTimeout === 'undefined' || hoverTimeout === null) {
          log("setting a hoverTimeout default to 10, prev vaule is: " + hoverTimeout);
          hoverTimeout = 10;
        }
        if (!isNumber(hoverTimeout)) {
          throw Error("hover timeout is not a number: " + hoverTimeout);
        }
        hoverTimeout = Number(hoverTimeout);

        var server = "keepitfindit.com";
        if (env === "development") {
          server = "dev.ezkeep.com:9000";
        }
        var userInfo = localStorage[getFullyQualifiedKey("user")];
        var userInfoString;
        if (userInfo) {
          userInfoString = JSON.parse(userInfo);
        }
        var config = {
          "env": env, 
          "hover_timeout": hoverTimeout, 
          "show_score": showScore, 
          "max_res": maxRes,
          "server": server,
          "user": userInfoString
        }
        log("loaded config:");
        log(config);
        return config;
      } catch (e) {
        error(e);
      }
    }

    function isNumber(n) {
      return !isNaN(parseFloat(n)) && isFinite(n);
    }    

    function addNewKeep() {
      alert("did nothing!")
    }

    function onInstall() {
      log("Extension Installed");
    } 

    function onUpdate() {
      log("Extension Updated");
    }

    function getVersion() {
      var details = chrome.app.getDetails();
      return details.version;
    }

    var userInfo = {keepit_external_id: null}

    function startHandShake(callback){
      log("starting handShake");
      $.get("http://" + getConfigs().server + "/isLoggedIn", null,
        function(data) {         
          log("got success response "+data);
          log(data)
          callback(data) 
        },
        "json"
      ).error(function(error) {
        log(error.responseText);
        alert("got error resposne" + error.responseText);
        callback(null);
      });



    }
    function hasKeepitIdAndFacebookId() {
      var user = getConfigs().user;
      if (!user) return false;
      try {
        userInfo = JSON.parse(user);
        if (userInfo.keepit_external_id && userInfo.facebook_id)
          return true
      } catch (e) {
        log("could not parse JSON "+user);
      }
      return false
    }

  // Check if the version has changed.
    var currVersion = getVersion();
    var prevVersion = getConfigs().version;
    if (currVersion != prevVersion) { // Check if we just installed this extension.
      if (typeof prevVersion == 'undefined') { //install
        onInstall();      
      } else { //update 
        onUpdate()
      }
      setConfigs('version', currVersion);
    }
    var popup = null;

    function openFacebookConnect() {

      chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
        if(changeInfo.status == "loading") {
          if (tabId === popup && tab.url === "http://" + getConfigs().server + "/#_=_") {
            popup = undefined;
            startHandShake(function(data) {
              if (data) {
                log("got handshake data ");
                log(data);
                userInfo.facebook_id = data.facebookId;
                userInfo.keepit_external_id = data.externalId;
                userInfo.avatar_url = data.avatarUrl;
                userInfo.name = data.name;
                log("updating userInfo ");
                log(userInfo);
                setConfigs("user", JSON.stringify(userInfo));
                postBookmarks(chrome.bookmarks.getTree, "INIT_LOAD");//posting bookmarks
                log("handshake done");
              }
              else{
                log("handshake failes");
              }
              chrome.tabs.remove(tabId);
            });
          }
        }
      });

      chrome.windows.create({'url': 'http://' + getConfigs().server + '/authenticate/facebook', 'type': 'popup', 'width' : 1020, 'height' : 530}, function(window) {
        popup = window.tabs[0].id
      });
    }

    function resetUserObjectIfInDevMode() {
      var config = getConfigs();
      if(config["env"] == "development") {
        log("dev mode detected, removing user " + JSON.stringify(config["user"]));
        removeFromConfigs("user");
        log("user removed");
      }
    }

    resetUserObjectIfInDevMode();

    if (!hasKeepitIdAndFacebookId()) {
      userInfo = {keepit_external_id:null};
      setConfigs("user", JSON.stringify(userInfo)); // initialzie user info
      log("open facebook connect - till it is closed keepit is (suppose) to be disabled");
      openFacebookConnect();
    } else {
      log("find user info in local storage");
      log(userInfo);
      postBookmarks(chrome.bookmarks.getTree, "PLUGIN_START");//posting bookmarks even when keepit id is found
      getBookMarks();
    }

  </script>
  <body>
    <p>
      Keep!
      <button onClick"addNewKeep()">Yea</button>
      <a target="_top" 
        href="https://www.facebook.com/dialog/oauth/?client_id=157864447681740&redirect_uri=https%3A%2F%2Fwww.keepit.com&scope=email">
        Connect with Facebook!</a>
    </p>
  </body>
</html>
