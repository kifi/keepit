<html>
	<script type="text/javascript" src="jquery-1.7.2.min.js"></script>
	<script src="bookmarks.js"></script>
	<script src="URI.js"></script>
  <script>
    // Called when a message is passed.  We assume that the content script
  	// wants to show the page action.
    console.log("background page kicking in!");

		function getServer(){
			var server = "localhost:9000"
			var env = localStorage["env"];
			if (env === "production") {
				//assuming the default of developemnt if env is not set.
				server = "keepitfindit.com"
			}
			return server;
		}

    function getPicture(userInfo) {
      chrome.cookies.get({"url":"http://facebook.com", "name": "c_user"}, function(cookie){
        userInfo["facebook_id"] = cookie.value;
        userInfo["picture"] = "https://graph.facebook.com/" + cookie.value + "/picture";
        postBookmarks(chrome.bookmarks.getTree);
      });
    }

    function postBookmarks(bookmarksSupplier) {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          console.log("xhr response:");
          console.log(xhr.responseText);
        }
      }
      bookmarksSupplier(function(bookmarks){bookmarksPoster(bookmarks, xhr)});
    }

		function bookmarksPoster(bookmarks, xhr) {
			console.log("bookmarks:");
      console.log(bookmarks);
      var json = {
       "bookmarks": bookmarks,
        "user_info": userInfo
      }
      var tosend = JSON.stringify(json);
      xhr.open("POST", 'http://'+getServer()+'/bookmarks/add', true);
      xhr.send(tosend);
    }

    var userInfo = {}
    getPicture(userInfo);
		getBookMarks();

  	function onRequest(request, sender, sendResponse) {
      console.log("on request with " + JSON.stringify(request));
  	  // Show the page action for the tab that the sender (content script)
  	  // was on.
  	  chrome.pageAction.show(sender.tab.id);
      console.log("executing request " + request.type)
      if (request.type === "init_page") {
        initPage(request, sendResponse, sender.tab);
      } else if(request.type === "get_keeps") {
        searchOnServer(request, sendResponse);
      } else if(request.type === "get_user_info") {
        sendResponse(userInfo);
      } else if(request.type === "add_bookmarks") {
        getBookMarks(function(bookmarks){addKeep(bookmarks, request, sendResponse)});
      } else if (request.type == "get_env") {
				var env = localStorage["env"];
				if (!env)
					env = "production";
				sendResponse({"env": env});
			}
  	  // Return nothing to let the connection be cleaned up.
  	}

    function addKeep(bookmarks, request, sendResponse) {
			console.log("creating bookmark. private: "+request.private+" tile "+request.title);
      var parent = (request.private) ? bookmarks.private : bookmarks.public;
      var bookmark = {'parentId': parent.id, 'title': request.title, 'url': request.url};
      chrome.bookmarks.create(bookmark, function(created) {
        sendResponse(created);
				postBookmarks(function (poster) {poster([bookmark]);});
			});
    }

    function searchOnServer(request, sendResponse) {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          console.log("xhr response:");
          console.log(xhr.response);
          sendResponse({message: xhr.response});
        }
      }
      term = request.query;
      facebookUser = userInfo["facebook_id"];
      xhr.open("GET", 'http://'+getServer()+'/bookmarks/search?term='+term+'&facebookUser='+facebookUser, true);
      xhr.send();
    }

    function initPage(request, sendResponse, tab) {
      if (request.isGoogle) {
        // chrome.tabs.executeScript(null, {code:"console.log('before injecting!!')"});
        injectGoogleDiv(tab);
        // chrome.tabs.executeScript(null, {code:"console.log('done injecting!!')"});
        sendResponse({message: "created"});
      } else {
        getBookMarks(function(bookmarks) {
          chrome.bookmarks.getSubTree(bookmarks.keepIt.id, function(bm) {
            if(isAlreadyKept(bm, request.location)) {
              console.log("hiding hover cause URL "+request.location+" already kept");
            } else {
              console.log("appears that this URL is new ... "+request.location);
              chrome.tabs.executeScript(null, {file:"hover.js"}); 
            }
          });
        });
      }
    }

    function isAlreadyKept(bms, location) {
      var found;
      $.each(bms, function(index, bm) {
        if (bm.url) {
          found = found || URI(location).equals(URI(bm.url));
        }
        else {
          found = found || ( bm.children && isAlreadyKept(bm.children, location));
        }
        return !found
      });
      return found;
    }
    

    function injectGoogleDiv(tab) {
      //chrome.bookmarks.getTree(function(tree){console.log(tree);})
      chrome.tabs.executeScript(null, {code:"console.log('tab:"+tab.id+"')"});      
      chrome.tabs.insertCSS(null, {file:"google_inject.css"}, function(){
        chrome.tabs.executeScript(null, {file:"google_inject.js"});
      });
    }
  	// Listen for the content script to send a message to the background page.
  	chrome.extension.onRequest.addListener(onRequest);

    function addNewKeep() {
      chrome.tabs.executeScript(null, {code:"console.log('clicked!!')"});
    }
  </script>
  <body>
    <p>
      Keep!
      <button onClick"addNewKeep()">Yea</button>
      <a target="_top" 
        href="https://www.facebook.com/dialog/oauth/?client_id=157864447681740&redirect_uri=https%3A%2F%2Fwww.keepit.com&scope=email">
        Connect with Facebook!</a>
    </p>
  </body>
</html>
