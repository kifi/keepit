<html>
  <script>
    // Called when a message is passed.  We assume that the content script
  	// wants to show the page action.
    console.log("background page kicking in!");

    var server = "keepitfindit.com"
    var env = localStorage["env"];
    if (env === "development") {
      //assuming the default of production if env is not set.
      server = "localhost:9000"
    }

    function getPicture(userInfo) {
      chrome.cookies.get({"url":"http://facebook.com", "name": "c_user"}, function(cookie){
        userInfo["facebook_id"] = cookie.value;
        userInfo["picture"] = "https://graph.facebook.com/" + cookie.value + "/picture";
        postBookmarks();
      });
    }

    function postBookmarks() {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          console.log("xhr response:");
          console.log(xhr.responseText);
        }
      }
      chrome.bookmarks.getTree(function(bookmarks) {
        console.log("bookmarks:");
        console.log(bookmarks);
        var json = {
          "bookmarks": bookmarks,
          "user_info": userInfo
        }
        var tosend = JSON.stringify(json);
        xhr.open("POST", 'http://'+server+'/bookmarks/add', true);
        xhr.send(tosend);
      });
    }

    var userInfo = {}
    getPicture(userInfo);

  	function onRequest(request, sender, sendResponse) {
      console.log("on request with " + JSON.stringify(request));
  	  // Show the page action for the tab that the sender (content script)
  	  // was on.
  	  chrome.pageAction.show(sender.tab.id);
      console.log("executing request " + request.type)
      if (request.type === "init_page") {
        initPage(request, sendResponse, sender.tab);
      } else if(request.type === "get_keeps") {
        //getKeeps(request, sendResponse);
        searchOnServer(request, sendResponse);
      } else if(request.type === "get_user_info") {
        sendResponse(userInfo);
      } else if(request.type === "add_bookmarks") {
        addKeep(request, sendResponse);
      }
  	  // Return nothing to let the connection be cleaned up.
  	}

    function addKeep(request, sendResponse) {
      chrome.bookmarks.getTree(function (res) {
        var root = res[0];
        var bookmarkBar = root.children[0];
        var bookmark = {'parentId': bookmarkBar.id, 'title': request.title, 'url': request.url};
        chrome.bookmarks.create(bookmark, function(created) {
          sendResponse(created);
        });        
      });
    }

    function getKeeps(request, sendResponse) {
      chrome.tabs.executeScript(null, {code:"console.log('got keeps message!!')"});
      chrome.bookmarks.search(request.query, function(results){
        sendResponse({message: results});
      })
    }

    function searchOnServer(request, sendResponse) {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          console.log("xhr response:");
          console.log(xhr.response);
          sendResponse({message: xhr.response});
        }
      }
      term = request.query;
      facebookUser = userInfo["facebook_id"];
      xhr.open("GET", 'http://'+server+'/bookmarks/search?term='+term+'&facebookUser='+facebookUser, true);
      xhr.send();

    }

    function initPage(request, sendResponse, tab) {
      if (request.isGoogle) {
        // chrome.tabs.executeScript(null, {code:"console.log('before injecting!!')"});
        injectGoogleDiv(tab);
        // chrome.tabs.executeScript(null, {code:"console.log('done injecting!!')"});
        sendResponse({message: "created"});
      } else {
        chrome.tabs.executeScript(null, {file:"hover.js"});
      }

    }

    function injectGoogleDiv(tab) {
      //chrome.bookmarks.getTree(function(tree){console.log(tree);})
      chrome.tabs.executeScript(null, {code:"console.log('tab:"+tab.id+"')"});      
      chrome.tabs.insertCSS(null, {file:"google_inject.css"}, function(){
        chrome.tabs.executeScript(null, {file:"google_inject.js"});
      });
    }
  	// Listen for the content script to send a message to the background page.
  	chrome.extension.onRequest.addListener(onRequest);

    function addNewKeep() {
      chrome.tabs.executeScript(null, {code:"console.log('clicked!!')"});
    }
  </script>
  <body>
    <p>
      Keep!
      <button onClick"addNewKeep()">Yea</button>
      <a target="_top" 
        href="https://www.facebook.com/dialog/oauth/?client_id=157864447681740&redirect_uri=https%3A%2F%2Fwww.keepit.com&scope=email">
        Connect with Facebook!</a>
    </p>
  </body>
</html>