<html>
	<script type="text/javascript" src="jquery-1.7.2.min.js"></script>
	<script src="bookmarks.js"></script>
	<script src="URI.js"></script>
  <script>
    // Called when a message is passed.  We assume that the content script
  	// wants to show the page action.

    function log(message, tab) {
      if(tab) {
        message = "[" + tab.id + "] " + message
      }
      console.log(message);
    }

    function error(exception, message) {
      debugger;
      var errMessage = exception.message;
      if(message) {
        errMessage = "[" + message + "] " + exception.message;
      }
      console.error(exception);
      console.error(errMessage);
      console.error(exception.stack);
      alert("exception: " + exception.message);
    }

    log("background page kicking in!");

    function extractFacbookInfo(userInfo, callback) {
      chrome.cookies.get({"url":"http://facebook.com", "name": "c_user"}, function(cookie){
        if (!cookie) {
          var message = "facebook cookie does not exist!"
          alert(message);
          throw Error(message);
        }
        try {
          userInfo.facebook_id = cookie.value;
          userInfo.avatarUrl = "https://graph.facebook.com/" + cookie.value + "/picture";
          localStorage["user_info"]=JSON.stringify(userInfo);
          callback(userInfo)
        } catch (e) {
          error(e);
        }
      });
    }

    function postBookmarks(bookmarksSupplier) {
      log("posging bookmarks...");
      try {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (xhr.readyState == 4) {
            log("[postBookmarks] xhr response:");
            log(xhr.responseText);
          }
        }
        bookmarksSupplier(function(bookmarks){
          try {
            bookmarksPoster(bookmarks, xhr);
          } catch (e) {
            error(e);
          }
        });
      } catch (e) {
        error(e);
      }
    }

		function bookmarksPoster(bookmarks, xhr) {
			log("bookmarks:");
      log(bookmarks);
      var json = {
       "bookmarks": bookmarks,
        "user_info": userInfo
      }
      var tosend = JSON.stringify(json);
      xhr.open("POST", 'http://' + getOptions().server + '/bookmarks/add', true);
      xhr.send(tosend);
      log("posted bookmarks");
    }

  	function onRequest(request, sender, sendResponse) {
      log("new request...");
      try {
        var tab = sender.tab;
        log("on request with " + JSON.stringify(request), tab);
    	  // Show the page action for the tab that the sender (content script) was on.
        log("executing request " + request.type, tab);
        if (request.type === "init_page") {
          initPage(request, sendResponse, tab);
        } else if(request.type === "get_keeps") {
          searchOnServer(request, sendResponse, tab);
        } else if(request.type === "get_user_info") {
          sendResponse(userInfo);
        } else if(request.type === "add_bookmarks") {
          getBookMarks(function(bookmarks) {
            addKeep(bookmarks, request, sendResponse, tab);
          });
        } else if (request.type == "get_opt") {
          var opt = getOptions();
  				sendResponse(opt);
        } else if (request.type == "upload_all_bookmarks") {
          upload_all_bookmarks();
        }
    	  // Return nothing to let the connection be cleaned up.
      } catch (e) {
        error(e);
      }
      log("done request...");
  	}

    function upload_all_bookmarks() {
      log("going to upload all my bookamrks to server");
      getPicture(userInfo);
      getKeepitId(userInfo)
    }

    function addKeep(bookmarks, request, sendResponse, tab) {
			log("creating bookmark. private: " + request.private + " tile " + request.title, tab);
      var parent = (request.private) ? bookmarks.private : bookmarks.public;
      var bookmark = {'parentId': parent.id, 'title': request.title, 'url': request.url};
      chrome.bookmarks.create(bookmark, function(created) {
        try {
          sendResponse(created);
  				postBookmarks(function (poster) {poster([bookmark]);});
        } catch (e) {
          error(e);
        }
			});
    }

    function searchOnServer(request, sendResponse, tab) {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          log("[searchOnServer] xhr response:", tab);
          log(xhr.response, tab);
          var searchResults = $.parseJSON(xhr.response);
          if (searchResults.length === 0) {
            return;
          }
          var maxRes = getOptions().maxRes;
          if (searchResults.length > maxRes) {
            searchResults = searchResults.slice(0, maxRes);
          }
          sendResponse(searchResults);
        }
      }
      term = request.query;
      keepitId = userInfo["keepit_id"];
      xhr.open("GET", 'http://' + getOptions().server + '/bookmarks/search?term=' + term + '&keepitId=' + keepitId, true);
      xhr.send();
    }

    function catching(block) {
      try {
        block();
      } catch (e) {
        error(e);
      }
    }

    var restrictedUrlPatternsForHover = [
      "www.facebook.com"
    ]

    function initPage(request, sendResponse, tab) {
      try {
        if (request.isGoogle === true) {
          log("injecting to google result page: starting...", tab);
          setTimeout(function() {
            injectGoogleDiv(tab);
            log("injecting to google result page: done!", tab);
          }, 5000);
        } else if (request.isGoogle === false) {
          var pageLocation = request.location;
          log("injecting hover: " + request, tab);
          var hoverTimeout = getOptions().hoverTimeout;
          var restrictedElements = $.grep(restrictedUrlPatternsForHover, function(e, i){
            return pageLocation.indexOf(e) >= 0;
          });
          if (restrictedElements.length > 0) {
            log("restricted hover page: " + restrictedElements);
            return;
          }
          if (hoverTimeout > 0) {
            getBookMarks(function(bookmarks) {
              chrome.bookmarks.getSubTree(bookmarks.keepIt.id, function(bm) {
                if(isAlreadyKept(bm, pageLocation)) {
                  log("hiding hover cause URL " + pageLocation + " already kept", tab);
                } else {
                  log("injecting hover: " + request, tab);
                  setTimeout(function() {
                    chrome.tabs.executeScript(tab.id, {code:"console.log('[keepit:hover] tab: " + tab.id + "')"}, 
                      function(vars){
                        log("[callback] executed hover remote logging", tab);
                    });
                    chrome.tabs.executeScript(tab.id, {file:"hover.js"});
                  }, hoverTimeout * 1000);
                }
              });
            });
          }
        } else {
          throw Error("request isGoogle is not well defined: " + request.isGoogle);
        }
      } catch (e) {
        error(e);
      }
    }

    function isAlreadyKept(bms, location) {
      try {
        var found;
        $.each(bms, function(index, bm) {
          if (bm.url) {
            found = found || URI(location).equals(URI(bm.url));
          }
          else {
            found = found || ( bm.children && isAlreadyKept(bm.children, location));
          }
          return !found
        });
        return found;
      } catch (e) {
        error(e);
      }
    }
    
    function injectGoogleDiv(tab) {
      log("injecting google_inject.js into tab", tab)
      try {
        chrome.tabs.executeScript(tab.id, {code:"console.log('[keepit:google] tab: " + tab.id + "')"}, 
          function(vars){
            log("[callback] executed logging", tab);
        });
        chrome.tabs.executeScript(tab.id, {file:"google_inject.js"}, function(vars){
          log("[callback] executed google_inject.js", tab);
        });
        log("injected google_inject.js into tab", tab)
      } catch (e) {
        error(e);
      }
    }

  	// Listen for the content script to send a message to the background page.
  	chrome.extension.onRequest.addListener(onRequest);

    function getOptions() {
      try {
        var env = localStorage["env"];
        if (!env) {
          env = "production";
        }
        var maxResStr = localStorage["max_search_results"]
        if (!isNumber(maxResStr)) {
          maxResStr = 5;
        }
        var maxRes = Number(maxResStr);

        var hoverTimeout = localStorage["hover_timeout"]
        if (!hoverTimeout) {
          hoverTimeout = 10;
        }
        if (!isNumber(hoverTimeout)) {
          hoverTimeout = 0;
        }
        hoverTimeout = Number(hoverTimeout);

        var server = "ezkeep.com";
        if (env === "development") {
          server = "localhost:9000";
        }
        return {
          "env": env, 
          "hoverTimeout": hoverTimeout, 
          "maxRes": maxRes,
          "server": server,
          "userInfo": JSON.parse(localStorage["user_info"])
        }
      } catch (e) {
        error(e);
      }
    }

    function isNumber(n) {
      return !isNaN(parseFloat(n)) && isFinite(n);
    }    

    function addNewKeep() {
      alert("did nothing!")
    }

    function onInstall() {
      log("Extension Installed");
    } 

    function obtainNewkeepitId(userInfo, callback){
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          log("[obtainNewkeepitId] xhr response:");
          var result = $.parseJSON(xhr.response);
          var keepitId = ""+result.userId;
          log(result);
          log("keepitId="+keepitId);
          userInfo.keepit_id = keepitId;
          localStorage["user_info"]=JSON.stringify(userInfo); 
          callback();
        }
      }
      xhr.open("POST", 'http://' + getOptions().server + '/users/anonymous', true);
      xhr.send(JSON.stringify({user_info:userInfo}));
    }

    function onUpdate() {
      log("Extension Updated");
    }

    function getVersion() {
      var details = chrome.app.getDetails();
      return details.version;
    }

    var userInfo = {keepit_id:null}

    function hasUserInfoInLocalStorage() {
      var ls = localStorage["user_info"];
      if (!ls) return false;
      try {
        userInfo = JSON.parse(ls);
        if (userInfo.keepit_id && userInfo.facebook_id) return true
      } catch (e) {
        log("could not parse JSON "+ls);
      }
      return false
    }

  // Check if the version has changed.
    var currVersion = getVersion();
    var prevVersion = localStorage['version']
    if (currVersion != prevVersion) { // Check if we just installed this extension.
      if (typeof prevVersion == 'undefined') { //install
        onInstall();      
      } else { //update 
        onUpdate()
      }
      localStorage['version'] = currVersion;
    }
  
    if (!hasUserInfoInLocalStorage()){
      userInfo = {keepit_id:null};
      localStorage["user_info"]=JSON.stringify(userInfo); // initialzie user info
      extractFacbookInfo(userInfo, function(userInfo) { 
        obtainNewkeepitId(userInfo, function(){
          postBookmarks(chrome.bookmarks.getTree);//posting bookmarks when a *new* keepit id is created
        })
      });
    } else {
      log("find user info in local storage");
      postBookmarks(chrome.bookmarks.getTree);//posting bookmarks even when keepit id is found
    }
    log(userInfo)

    getBookMarks();

  </script>
  <body>
    <p>
      Keep!
      <button onClick"addNewKeep()">Yea</button>
      <a target="_top" 
        href="https://www.facebook.com/dialog/oauth/?client_id=157864447681740&redirect_uri=https%3A%2F%2Fwww.keepit.com&scope=email">
        Connect with Facebook!</a>
    </p>
  </body>
</html>
