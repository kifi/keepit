<html>
  <head>
    <title>Keep It Extension Configs</title>
  </head>

  <script type="text/javascript" src="jquery-1.7.2.min.js"></script>
  <script type="text/javascript">

  // Saves configs to localStorage.

  $("#user_info_data").hide();
  $("#connect_to_server").hide();

  
  function upload() {
    chrome.extension.sendRequest({type: "upload_all_bookmarks"}, function(response) {});
  }

  function resetUser() {
    chrome.extension.sendRequest({type: "remove_conf", key: "user"}, function(response) {
      chrome.extension.sendRequest({type: "remove_conf", key: "user_info"}, function(response) {
        restoreConfigs();
      });  
    });
  }

  function sendSaveConfig(key, value) {
    chrome.extension.sendRequest({type: "set_conf", key: key, value: value}, function(response) {});
  }

  function saveConfigs() {
    if ($("#env_prod").is(":checked")) {
      localStorage["env"] = "production";
    }
    else {
      localStorage["env"] = "development";
    }
    sendSaveConfig("maxRes", $("#max_search_results").val());
    sendSaveConfig("hoverTimeout", $("#hover_timeout").val());
    sendSaveConfig("showScore", $("#show_score").val());
  }

  function getuserinfo(callback) {
    chrome.extension.sendRequest({"type": "get_conf"}, function(config) {
      $.get("http://" + config.server + "/isLoggedIn",
          null,
          function(data) {         
            callback(data) 
          },
          "json"
      ).error(function(error) {
        log(error.responseText);
        alert("user is not logged in: " + error.responseText);
        callback(null);
      });
    });
  }

  function renderUserInfo(userInfo) {
    if (userInfo && userInfo.status && userInfo.status=="loggedin") {
      setConfigs("user", JSON.stringify(userInfo));
      $("#user_info_data").show();
      $("#connect_to_server").hide();
      $("#user_name").html(userInfo.name);
      $("#user_avatar").attr("src", userInfo.avatar_url);
    } else {
      removeFromConfigs("user");
      $("#connect_to_server").show();
      $("#user_info_data").hide();
    }     
  }

  function restoreConfigs() {
    chrome.extension.sendRequest({"type": "get_conf"}, function(config) {
      var env = config.env;
      if (env=="development") {
        $("#env_dev").attr("checked","checked");
      }
      if (env=="production") {
        $("#env_prod").attr("checked","checked");
      }
      $("#max_search_results").val(config.maxRes);
      $("#hover_timeout").val(config.hoverTimeout);
      $("#show_score").val(config.shoScore);
      $("#facebook_connect_link").click(function() {
        chrome.extension.sendRequest({"type": "get_conf"}, function(config) {
          var url = "http://" + config.server + "/authenticate/facebook";
          log("openning facebook window from " + url, "connect", "width=500,height=400");
          window.open(url);
          return false;
        });
      });  
    });
    getuserinfo(renderUserInfo);
  }
  </script>

  <body onload="restoreConfigs()">
      
      <div id="user_info">
        <div id="user_info_data">
          Hello: <span id="user_name"></span><img id="user_avatar" src="#"></img>
        </div>
        <div id="connect_to_server">
          <a id="facebook_connect_link" target="_" href="#"><img src="facebookConnect.png"></img></a>
        </div>
      </div> 

    <div width="100px">
      <fieldset>
        <legend>Environment:</legend>
        <input type="radio" id="env_dev"  name="env" value="development"/>Development<br/>
        <input type="radio" id="env_prod" name="env" value="production"/>Production<br/> 
        Max Search Results: <input type="text" id="max_search_results" name="max_search_results" value="10"></input><br/> 
        Show Hover timeout in seconds: <input type="text" id="hover_timeout" name="hover_timeout" value="10"></input><br/> 
        Show score (use 'yes' if you want it): <input type="text" id="show_score" name="show_score" value="no"></input><br/> 
        <font size="small">If the value of the timeout is not a positive number (as in '0' or "NA") the hover will not show</font><br/> 
        <button onclick="saveConfigs()">Save</button><br/> 
        <button onclick="upload()">Upload all my bookmarks</button><br/> 
        <button onclick="resetUser()">Reset User Info</button><br/> 
      </fieldset>
    </div>
  </body>
</html>
