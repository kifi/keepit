<html>
  <head>
    <title>Keep It Extension Configs</title>
  </head>

  <script type="text/javascript" src="jquery-1.7.2.min.js"></script>
  <script type="text/javascript">

  // Saves configs to localStorage.
  
  function upload() {
    chrome.extension.sendRequest({type: "upload_all_bookmarks"}, function(response) {});
  }

  function saveConfigs() {
    if ($("#env_prod").is(":checked")) {
      localStorage["env"] = "production";
    }
    else {
      localStorage["env"] = "development";
    }
    localStorage["max_search_results"] = $("#max_search_results").val();
    localStorage["hover_timeout"] = $("#hover_timeout").val();
    var keepitId = $("#keepit_id").val();
    localStorage["user_info"]= JSON.stringify(localStorage["user_info"])
  }

  function getuserinfo(callback) {
    chrome.extension.sendRequest({"type": "get_conf"}, function(config) {
      $.get("http://" + config.server + "/isLoggedIn",
          null,
          function(data) {         
            callback(data) 
          },
          "json"
      ).error(callback);
    });
  }


  function renderUserInfo(userInfo) {
    if (userInfo && userInfo.status && userInfo.status=="loggedin") {
      localStorage["user_info"]  = JSON.stringify(userInfo);
      $("#user_info_data").show();
      $("#connect_to_server").hide();
      $("#user_name").html(userInfo.name)
      $("#user_avatar").attr("src",userInfo.avatarUrl);
    } else {
      localStorage["user_info"]  = null;
      $("#connect_to_server").show();
      $("#user_info_data").hide();
    }     
  }
  function restoreConfigs() {
    var env = localStorage["env"];

    if (!env) {
      env = "production";
      localStorage["env"]=env;
    }

    if (env=="development") {
      $("#env_dev").attr("checked","checked");
    }
    if (env=="production") {
      $("#env_prod").attr("checked","checked");
    }
    $("#max_search_results").val(localStorage["max_search_results"]);
    $("#hover_timeout").val(localStorage["hover_timeout"]);
    if (localStorage["user_info"]) {
      var userInfo = JSON.parse(localStorage["user_info"]);
      if (userInfo && userInfo.keepit_id) {
        $("#keepit_id").val(userInfo.keepit_id);
      }
    }

  $("#facebook_connect_link").click(function() {
    chrome.extension.sendRequest({"type": "get_conf"}, function(config) {
      window.open("http://" + config.server + "/authenticate/facebook", "connect", "width=500,height=400");
      return false;
    });
  });
  
  getuserinfo(renderUserInfo);

  }
  </script>

  <body onload="restoreConfigs()">
      
      <div id="user_info">
        <div id="user_info_data">
          Hello: <span id="user_name"></span><img id="user_avatar" src="#"></img>
        </div>
        <div id="connect_to_server">
          <a id="facebook_connect_link" target="_" href="#"><img src="facebookConnect.png"></img></a>
        </div>
      </div> 

    <div width="100px">
      <fieldset>
        <legend>Environment:</legend>
        <input type="radio" id="env_dev"  name="env" value="development"/>Development<br/>
        <input type="radio" id="env_prod" name="env" value="production"/>Production<br/> 
        Max Search Results: <input type="text" id="max_search_results" name="max_search_results" value="10"></input><br/> 
        Show Hover timeout in seconds: <input type="text" id="hover_timeout" name="hover_timeout" value="10"></input><br/> 
        <font size="small">If the value of the timeout is not a positive number (as in '0' or "NA") the hover will not show</font><br/> 
        KeepIt ID: <input type="text" id="keepit_id" name="keepit_id" value="10" readonly="readonly"></input><br/> 
        <button onclick="saveConfigs()">Save</button>
        <button onclick="upload()">Upload all my bookmarks</button>
      </fieldset>
    </div>
  </body>
</html>
