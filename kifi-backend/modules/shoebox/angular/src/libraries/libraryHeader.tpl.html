<div class="kf-lh" itemscope itemtype="http://schema.org/CollectionPage">
  <div class="kf-lh-cover" ng-class="{'kf-system-main': library.kind === 'system_main', 'kf-system-secret': library.kind === 'system_secret'}" ng-style="{'background-color': library.color}">
    <meta itemtype="image" content="{{library.image|libImageUrl}}" ng-if="library.image"/>
    <meta itemtype="url" content="{{library.absUrl}}"/>

    <div class="kf-lh-cover-image" ng-class="{'kf-fade-in': !settingImage}" ng-attr-style="{{library.image|shadedBackgroundImage:.2:.6}}" ng-if="library.image && imageLoaded"></div>

    <div class="kf-lh-invite-banner" ng-if="library.invite && !library.invite.actedOn">
      <div class="kf-lh-invite-banner-text">{{library.invite.inviterName}} has invited<br>you to follow this library</div>
      <button class="kf-lh-invite-banner-button kf-ignore" ng-click="ignoreInvitation()">Ignore</button>
      <button class="kf-lh-invite-banner-button kf-accept" ng-click="acceptInvitation()">Accept</button>
    </div>

    <div class="kf-lh-top">
      <div class="kf-lh-private svg-card-lock" ng-if="library.visibility === 'secret'"></div>

      <button class="kf-lh-manage-btn svg-settings-gear-filled" ng-click="manageLibrary()" ng-if="isMyLibrary() && !library.isSystem"></button>

      <div class="kf-lh-cover-menu-parent" kf-hover-menu ng-if="isMyLibrary() && !library.isSystem">
        <button class="kf-lh-cover-menu-btn svg-camera-filled"></button>
        <menu class="kf-dropdown-menu kf-lh-cover-menu">
          <button class="kf-dropdown-menu-item kf-lh-cover-add" ng-if="!library.image" kf-hover ng-mouseup="onAddCoverImageMouseUp($event)">Add a cover image</button>
          <button class="kf-dropdown-menu-item kf-lh-cover-move" ng-if="library.image" kf-hover ng-mouseup="onMoveCoverImageMouseUp($event)">Reposition cover image</button>
          <button class="kf-dropdown-menu-item kf-lh-cover-change" ng-if="library.image" kf-hover ng-mouseup="onChangeCoverImageMouseUp($event)" onmouseup="event.button?null:angular.element('.kf-lh-cover-file').click()">Change cover image</button>
          <button class="kf-dropdown-menu-item kf-lh-cover-remove" ng-if="library.image" kf-hover ng-mouseup="onRemoveCoverImageMouseUp($event)">Remove cover image</button>
        </menu>
      </div>
      <input class="kf-lh-cover-file" type="file" accept="image/jpeg,image/png,image/gif" kf-file-change="onCoverImageFileChosen" ng-if="isMyLibrary() && !library.isSystem">

      <button class="kf-lh-subscribed-btn" ng-class="{'for-owner': isMyLibrary()}" ng-click="changeSubscription()" ng-if="library.access !== 'none' && (!amOwner || hasCollaborators)">
        <div class="kf-lh-subscribed-icon" ng-class="{'svg-notification-on-white': library.subscribed, 'svg-notification-off-white': !library.subscribed}"></div>
        <span class="kf-lh-notifications-msg" ng-class="{'kf-lh-enabled': library.subscribed, 'kf-lh-disabled': !library.subscribed}"></span>
      </button>

      <div class="kf-lh-followers">
        <a class="kf-lh-followers-a" ng-repeat="follower in followersToShow" href="{{follower|profileUrl}}" kf-track-origin="libraryPage/follower">
          <img class="kf-lh-followers-pic" ng-src="{{follower|pic:100}}" alt="{{follower|name}}">
          <span class="kf-lh-followers-name">{{follower.firstName}}</span>
        </a>
        <button class="kf-lh-followers-more" ng-if="numMoreFollowersText" ng-click="showFollowers()">
          <span class="kf-lh-followers-more-text kf-{{numMoreFollowersText.length}}">{{numMoreFollowersText}}</span>
        </button>
      </div>
    </div>

    <div class="kf-lh-cover-preview" ng-attr-style="{{imagePreview|shadedBackgroundImage:.2:.6}}" ng-if="imagePreview"></div>
    <div class="kf-lh-cover-glass" ng-class="{'kf-ew': imagePreview.progress === undefined && imagePreview.w / imagePreview.natural.w < imagePreview.h / imagePreview.natural.h, 'kf-ns': imagePreview.progress === undefined && imagePreview.w / imagePreview.natural.w >= imagePreview.h / imagePreview.natural.h}" ng-mouseover="onImagePreviewMouseOver($event)" ng-mousedown="onImagePreviewMouseDown($event)" ng-if="imagePreview">
      <span class="kf-lh-cover-prompt">Drag to position image</span>
      <button class="kf-lh-cover-apply" ng-click="applyCoverImageChange()">Apply</button>
      <button class="kf-lh-cover-cancel" ng-click="cancelCoverImageChange()">Cancel</button>
      <div class="kf-lh-cover-progress" ng-style="{width: imagePreview.progress + '%', 'background-color': imagePreview.progress === 0 ? '#b00' : null, 'transition-timing-function': imagePreview.progress % 100 ? null : 'ease-in', 'transition-duration': imagePreview.progress === 0 ? '.6s' : null}" ng-if="imagePreview.progress >= 0"></div>
    </div>

    <div class="kf-lh-mid">
      <div class="kf-lh-icon" ng-class="{'svg-card-star': library.kind === 'system_main', 'svg-card-lock': library.kind === 'system_secret'}"></div>
      <h1 class="kf-lh-name" ng-class="{'kf-long-1': library.name.length > 24, 'kf-long-2': library.name.length > 36}" itemtype="name">{{library.name|preventOrphans:16:0.6}}</h1>

      <div class="kf-lh-stats">
        <span class="kf-lh-stat" ng-pluralize count="library.numKeeps" when="{'one': '1 keep', 'other': '{{library.numKeeps|number}} keeps'}" ng-if="library.numKeeps"></span>
      </div>

      <!-- owner only -->
      <div class="kf-lh-owner" itemprop="creator" itemscope itemtype="http://schema.org/Person" ng-if="!hasCollaborators">
        <div class="kf-lh-owner-image-wrap">
          <a class="kf-lh-owner-image-a" href="{{library.owner|profileUrl}}" itemprop="url" kf-track-origin="libraryPage/curator">
            <img class="kf-lh-owner-image" ng-src="{{library.owner|pic:200}}" itemprop="image" alt="{{library.owner|name}}">
          </a>
          <button class="kf-lh-add-collab-button next-to-owner" ng-if="!library.attr.twitter.screenName && library.access === 'owner' && onCollabExperiment" ng-click="openInviteModal('collaborate')">
            <div class="kf-lh-add-collab-icon svg-collaborator-white"></div>
            <span class="kf-lh-add-collab-msg">Invite a collaborator</span>
          </button>
        </div>
        <div class="kf-lh-owner-name-wrap">
          <a class="kf-lh-owner-name" href="{{library.owner|profileUrl}}" itemprop="name" kf-track-origin="libraryPage/curator">{{library.owner|name}}</a>
          <a class="kf-lh-owner-twitter-a svg-twitter-blue" href="https://www.twitter.com/{{library.attr.twitter.screenName}}" target="_blank" title="@{{library.attr.twitter.screenName}}" ng-if="library.attr.twitter.screenName" ng-click="trackTwitterProfile()"></a>
        </div>
      </div>

      <!--  owner with collaborators -->
      <div class="kf-lh-collabs" ng-if="hasCollaborators">
        <div class="kf-lh-collab-image-wrap">
          <a class="kf-lh-collab-image-a" href="{{library.owner|profileUrl}}" itemprop="url" kf-track-origin="libraryPage/collaborator">
            <img class="kf-lh-collab-image" ng-src="{{library.owner|pic:200}}" itemprop="image" alt="{{library.owner.firstName}}">
          </a>
          <a class="kf-lh-collab-name" href="{{library.owner|profileUrl}}" itemprop="name" kf-track-origin="libraryPage/collaborator">{{library.owner.firstName}}</a>
        </div>
        <div class="kf-lh-collab-image-wrap" ng-repeat="collab in library.collaborators">
          <a class="kf-lh-collab-image-a" href="{{collab|profileUrl}}" itemprop="url" kf-track-origin="libraryPage/collaborator">
            <img class="kf-lh-collab-image" ng-src="{{collab|pic:200}}" itemprop="image" alt="{{collab|name}}">
          </a>
          <a class="kf-lh-collab-name" href="{{collab|profileUrl}}" itemprop="name" kf-track-origin="libraryPage/collaborator">{{collab.firstName}}</a>
        </div>
        <button class="kf-lh-more-collab" ng-if="library.numCollaborators - library.collaborators.length > 0">
          +{{library.numCollaborators - library.collaborators.length}}
        </button>
        <button class="kf-lh-add-collab-button" ng-if="(library.access == 'owner' || (library.access == 'read_write' && library.whoCanInvite == 'collaborator')) && onCollabExperiment" ng-click="openInviteModal('collaborate')">
          <div class="kf-lh-add-collab-icon svg-collaborator-white"></div>
          <span class="kf-lh-add-collab-msg">Invite a collaborator</span>
        </button>
      </div>

    </div>
  </div>

  <div class="kf-lh-desc-wrap-2" ng-class="{'kf-long': descFits === false}" ng-attr-style="border-color:{{library.color}}">
    <div class="kf-lh-desc-wrap" kf-wheel-stop="{{descScrollable}}">
      <div class="kf-lh-desc" ng-bind-html="library.descriptionHtml" itemtype="description" kf-wheel-allow></div>
    </div>
    <button class="kf-lh-desc-toggle" ng-click="descExpanded === false ? expandDescription() : descExpanded === true ? collapseDescription() : null">
      {{descExpanded === false ? 'Continue readingâ€¦' : descExpanded === true ? 'Show less' : ''}}
    </button>
    <button class="kf-lh-desc-add" ng-click="manageLibrary()" ng-if="!library.description && isMyLibrary() && !library.isSystem">Add a description</button>
  </div>

  <div class="kf-lh-buttons" ng-if="!isMyLibrary()">
    <div class="kf-lh-follow-btn-wrap" ng-if="!followingLibrary()">
      <div kf-library-header-follow-button-cta library="library" ng-if="!isMobile && library.abTest.name === 'exp_follow_popup' && library.abTestTreatment.data"></div>
      <button class="kf-button kf-lh-follow-btn" ng-click="followLibrary(true)">{{library.abTestTreatment.data.buttonText || 'Follow'}}</button>
    </div>
    <button class="kf-button kf-lh-unfollow-btn" ng-class="{'kf-no-unfollow': followBtnJustClicked}" ng-click="unfollowLibrary()" ng-mouseleave="onUnfollowBtnMouseLeave()" ng-if="followingLibrary()"></button>
    <div kf-library-share-search library="library" current-page-origin="libraryPage" btn-icon-class="svg-share-arrow-green" ng-if="$root.userLoggedIn && library.visibility === 'published'"></div>
  </div>
  <div class="kf-lh-buttons kf-my-lib clearfix" ng-if="isMyLibrary()">
    <button class="kf-button kf-lh-edit-keeps svg-bullet-list-green" ng-click="toggleEditKeeps()" ng-if="library.numKeeps > 0 && !librarySearch">{{editMode ? 'Done editing' : 'Edit keeps'}}</button>
    <div kf-library-share-search library="library" current-page-origin="libraryPage" ng-if="!library.isSystem"></div>
  </div>
</div>
