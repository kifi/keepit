<span class="kf-structured-text">
  <span ng-repeat="segment in segments"
        ng-switch="segment.kind || segment.type"><!--
    --><a ng-switch-when="author"
       class="kf-feed-tooltip-target kf-link kf-structured-text-user"
       ng-href="{{segment.url}}"
       ng-style="{'background': library.color}"
       kf-maybe-external-target
       ng-init="user={firstName: segment.text, image: segment.image}"
       kf-user-tooltip="user">
      <span ng-bind="segment.text"></span>
    </a><!--
    --><a ng-switch-when="user"
       class="kf-feed-tooltip-target kf-link kf-structured-text-user"
       ng-href="{{segment.url}}"
       kf-maybe-external-target
       ng-style="{'background': library.color}"
       ng-init="user={firstName: segment.text, image: segment.image}"
       kf-user-tooltip="user">
      <span ng-bind="segment.text"></span>
    </a><!--
    --><span ng-switch-when="library"
       class="kf-structured-text-library kf-feed-tooltip-target"
       kf-user-tooltip
       library="library"
       ng-init="library = {id: segment.id}">
      <a class="kf-link" ng-href="{{segment.url}}" ng-bind="segment.text"></a>
    </span><!--
    --><a ng-switch-when="organization"
       class="kf-feed-tooltip-target kf-link kf-structured-text-organization"
       ng-init="org={name: segment.text, avatarPath: segment.image}"
       ng-href="{{segment.url}}"
       kf-user-tooltip="org">
      <span ng-bind="segment.text"></span>
    </a><!--
    --><span ng-switch-default
          ng-if="segment.text"
          class="kf-structured-text-text">
      <a
        class="kf-link kf-link-underline"
        ng-if="isSegmentLink(segment)"
        ng-class="{ 'kf-tooltip-parent kf-tooltip-parent-noclose': isSegmentHover(segment) }"
        ng-href="{{ segment.url }}"
        kf-maybe-external-target
        ng-click="trackActivityClick(descriptionSegment.url)"
      >
        <span ng-bind="segment.text"></span>
        <div ng-if="isSegmentHover(segment)" class="kf-tooltip-body">
          <span kf-structured-text segments="segment.hover"></span>
        </div>
      </a><!--
      --><div
        class="kf-link kf-link-underline kf-link-black kf-structured-text-hover kf-tooltip-parent kf-tooltip-parent-noclose"
        ng-if="isSegmentHover(segment) && !isSegmentLink(segment)"
      >
        <span ng-bind="segment.text"></span>
        <div class="kf-tooltip-body">
          <span kf-structured-text segments="segment.hover"></span>
        </div>
      </div><!--
      --><span
        ng-if="isSegmentText(segment)"
        ng-bind="segment.text"
      ></span>
    </span><!--
      These are segments generated by the message processing service. In the future some of these may be
      replaced by segment kinds from the server directly.
    --><div  ng-switch-when="IMAGE"
          class="kf-keep-activity-event-block"
          ng-class="{'kf-keep-activity-event-v-space': !$last, 'kf-keep-activity-event-v-space-top': $index - 1 >= 0 && commentParts[$index - 1].type !== 'IMAGE'}">
      <img class="kf-keep-activity-event-embedded-img" ng-src="{{segment.data.src}}"/>
    </div><!--

    --><span ng-switch-when="TEXT_PLAIN" ng-bind="segment.data.text" class="kf-keep-activity-event-inline"></span><!--

    --><div ng-switch-when="EMAIL" class="kf-keep-activity-event-inline">
      <a ng-href="mail-to:{{segment.data.text}}" ng-bind="segment.data.text" class="kf-link-blue kf-keep-activity-event-inline"></a>
    </div><!--

    --><div ng-switch-when="LINK" class="kf-keep-activity-event-inline">
      <a ng-href="{{segment.data.link}}" kf-maybe-external-target ng-bind="segment.data.text" class="kf-link-blue kf-keep-activity-event-inline"></a>
    </div><!--

    --><span ng-switch-when="LOOK_HERE">
      <div class="kf-keep-activity-event-inline">
        <a ng-href="#" ng-click="openLookHere($event, segment)" title="{{segment.data.title}}" ng-bind="segment.data.text" class="kf-link-blue kf-keep-activity-event-look-here-link kf-keep-activity-event-inline"/>
      </div>
      <div class="kf-keep-activity-event-look-here-container">
        <div class="kf-keep-activity-event-look-here-left-divider"></div>
        <div class="kf-keep-activity-event-look-here-inside">
          <span kf-structured-text segments="segment.data.parts"></span>
        </div>
      </div>
    </span><!--
  --></span>
</span>
