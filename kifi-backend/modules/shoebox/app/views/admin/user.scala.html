@(user: User,
  totalBookmarks: Int,
  experiments: Set[ExperimentType],
  bookmarks: Seq[(Bookmark, NormalizedURI, Seq[String])],
  socialUsers: Seq[SocialUserInfo],
  socialConnections: Seq[SocialUserInfo],
  fortyTwoConnections: Seq[User],
  kifiInstallations: Seq[KifiInstallation],
  historyUpdateCount: Int,
  bookmarkSearch: Option[String],
  allowedInvites: Int,
  emails: Seq[EmailAddress],
  abookInfos: Seq[ABookInfo],
  contactInfos: Seq[ContactInfo],
  abookEP: Option[String],
  collections: Seq[Collection],
  collectionFilter: Option[Id[Collection]]
)

@admin("User: " + user.firstName + " " + user.lastName, stylesheets = List("admin_user")) {
    <button class="btn" id="refresh_sui" onclick="refreshAllSocialUserInfo()">Refresh Social User Info!</button>
    <button class="btn" onclick="impersonate()">Impersonate User</button>
    <button class="btn" onclick="unimpersonate()">Stop Impersonating</button>
    <button class="btn" onclick="configSearch()">Config Search</button>
    <br/>
    <table class="user-summary table table-bordered">
      <tr>
        <th>Name</th><td>@user.firstName @user.lastName</td>
      </tr>
      <tr>
        <th>Id</th><td>@user.id</td>
      </tr>
      <tr>
        <th>Social Users</th>
        <td>
          @for(u <- socialUsers) { <div>@adminHelper.socialUserDisplay(u, true)</div> }
        </td>
      </tr>
      <tr>
        <th>Created At</th><td>@adminHelper.dateTimeDisplay(user.createdAt)</td>
      </tr>
      <tr>
        <th>Last Update</th><td>@adminHelper.dateTimeDisplay(user.updatedAt)</td>
      </tr>
      <tr>
        <th>Email</th>
        <td>
          <form action="@com.keepit.controllers.admin.routes.AdminUserController.updateUser(user.id.get)" method="POST" class="form-inline">
            <input type="text" name="emails" value="@{emails.map(_.address).mkString(",")}">
            <input type="submit" value="Save">
          </form>
        </td>
      </tr>
      <tr>
        <th>Allowed Invites</th>
        <td>
          <form action="@com.keepit.controllers.admin.routes.AdminUserController.setInvitesCount(user.id.get)" class="form-inline" method="POST">
            <input type="text" name="allowedInvites" value="@allowedInvites">
            <input type="submit" value="Save">
          </form>
        </td>
      </tr>
      <tr>
        <th>Experiments</th>
        <td id="experiments" class="form-inline">
          @for(exp <- Seq(ExperimentType.ADMIN, ExperimentType.BLOCK,
              ExperimentType.NO_SEARCH_EXPERIMENTS, ExperimentType.FAKE, ExperimentType.INACTIVE,
              ExperimentType.CAN_INVITE, ExperimentType.CAN_MESSAGE_ALL_USERS, ExperimentType.NOT_SENSITIVE,
              ExperimentType.PASSWORD_LOGIN, ExperimentType.TAGGING)) {
            <label class="checkbox">
              <input type="checkbox" data-exp="@exp.value" @if(experiments.contains(exp)) {checked}>@exp.value
            </label>
          }
        </td>
      </tr>
      <tr>
        <th>State</th>
        <td class="form-inline">
          <select id="state">
          @for(state <- Seq(UserStates.ACTIVE, UserStates.INACTIVE, UserStates.PENDING, UserStates.BLOCKED)) {
            <option  @if(user.state.value == state.value){selected}>@state.value</option>
          }
          </select>
        </td>
      </tr>
      @if(user.state != UserStates.ACTIVE) {
      <tr>
        <th>Merge to User ID</th>
        <td><form class="form-inline" method="post"
            action="@com.keepit.controllers.admin.routes.AdminUserController.merge">
          <input type="hidden" name="from" value="@user.id.get">
          <input type="text" name="to">
          <input type="submit" value="Merge!">
        </form></td>
      </tr>
      }
      <tr>
        <th>Useful page update count</th>
        <td>@historyUpdateCount</td>
      </tr>
    </table>
    <p>
      <a href="@com.keepit.controllers.admin.routes.AdminUserController.moreUserInfoView(user.id.get)">More User Info</a>
    </p>

	<div class="row-fluid">
	  <ul class="thumbnails">
      <li class="span6 well">
        <h2>@socialConnections.size Social Users</h2>
        <div class="scrollArea">
          <ol>
          @for(socialConnection <- socialConnections) {
            <li>@adminHelper.socialUserDisplay(socialConnection)</li>
          }
          </ol>
        </div>
      </li>
	    <li class="span6 well">
	      <h2>@fortyTwoConnections.size FortyTwo Users</h2>
	      <div class="scrollArea">
	        <ol>
	        @for(u <- fortyTwoConnections) {
	          <li>@adminHelper.userDisplay(u)</li>
	        }
	        </ol>
	      </div>
	    </li>
	  </ul>
	</div>
  <h2>User has uploaded @abookInfos.size Address Book(s)</h2>
  @if(abookInfos.size > 0) {
    <h3>Address Book(s)</h3>
    <table class="table table-condensed table-striped">
        <tr><th>ABookId</th><th>Origin</th><th>State</th><th>RawInfoLoc</th></tr>
        @for(abookInfo <- abookInfos) {
            <tr><td>@abookInfo.id</td><td>@abookInfo.origin</td><td>@abookInfo.state</td><td>@abookInfo.rawInfoLoc</td></tr>
        }
    </table>
  }
  @if(contactInfos.size > 0) {
    <h3>Contacts</h3>
    <div class="scrollArea">
        <table class="table table-condensed table-striped">
            <tr><th>ContactId</th><th>Origin</th><th>ABookId</th><th>Name</th><th>Email</th></tr>
            @for(contactInfo <- contactInfos) {
                <tr><td>@contactInfo.id</td><td>@contactInfo.origin</td><td>@contactInfo.abookId</td><td>@contactInfo.name</td><td>@contactInfo.email</td></tr>
            }
        </table>
    </div>
  }
  @if(abookEP.isDefined) {
    <h3>Upload Address book</h3>
    <h4>Gmail Exported (Outlook-styled) CSV -- 42-internal testing only!</h4>
    <form class="form-inline" action=@{abookEP.get + user.id.get + "/uploadGMailCSV"} enctype="multipart/form-data" method="POST">
        Gmail CSV file to upload: <input type=file name="gmail_csv">
        <input type=submit value="Upload">
    </form>
    <h4>IOS JSON file upload -- 42-internal testing only!</h4>
    <form class="form-inline" action=@{abookEP.get + user.id.get + "/ios/upload"} enctype="multipart/form-data" method="POST">
        IOS JSON file to upload: <input type=file name="abook_json">
        <input type=submit value="Upload">
    </form>
  }
  <h2>User kept @totalBookmarks Bookmarks</h2>
  <h3>Showing @bookmarks.size Bookmarks of total @totalBookmarks</h3>
  <form class="form-inline" action="@com.keepit.controllers.admin.routes.AdminUserController.userView(user.id.get)" method="POST">
    @if(bookmarkSearch.isDefined){
      <input type="text" name="bookmarkSearch" value="@{bookmarkSearch.get}"/>
    } else {
      <input type="text" name="bookmarkSearch" placeholder="query"/>
    }
    <select name="collectionFilter">
      <option value="-1">All collections</option>
    @for(c <- collections) {
      <option value="@c.id.get" @if(collectionFilter == c.id) { selected }>@c.name</option>
    }
    </select>
    <input type="submit" value="Search"/>
  </form>
  <form class="navbar-form" action="@com.keepit.controllers.admin.routes.AdminBookmarksController.updateBookmarks()"
  method="POST">
    <button type="submit" class="btn">Update</button><br/><br/>
			<table class="table table-bordered">
		    <tr>
		      <th>#</th>
		      <th>BID</th>
		      <th>Private</th>
		      <th>Active</th>
		      <th>Bookmark</th>
              <th>Collections</th>
              <th>Source</th>
          <th>Created At</th>
          <th>State</th>
		    </tr>
			 @for(((bookmark, uri, collections), i) <- bookmarks.zipWithIndex) {
			   <tr>
		        <td>@{i+1}</td>
		        <td><span class="badge">@bookmark.id.get.id</span></td>
		        <td>
		          <input type="hidden" name="private_@{bookmark.id.get.id}" value="0" />
  					  <center><input type="checkbox" id="private_@bookmark.id.get.id" name="private_@{bookmark.id.get.id}" value="1" @if(bookmark.isPrivate) {checked="checked"}"></input></center>
		        </td>
		        <td>
              <input type="hidden" name="active_@{bookmark.id.get.id}" value="0" />
							<center><input type="checkbox" id="active_@bookmark.id.get.id" name="active_@{bookmark.id.get.id}" value="1" @if(bookmark.state.value == "active") {checked="checked"}"></input></center>
		        </td>
		        <td>@adminHelper.bookmarkDisplay(bookmark)</td>
                <td><div class="collections" data-id="@bookmark.id.get.id">@{collections.mkString(", ")}</div></td>
                <td>@bookmark.source</td>
            <td>@adminHelper.dateTimeDisplay(bookmark.createdAt)</td>
            <td>@adminHelper.uriStateDisplay(uri)</td>
			   </tr>
			 }
			</table>
    <button type="submit" class="btn">Update</button>
  </form>

  <script type="text/javascript">
    function refreshAllSocialUserInfo() {
      $("#refresh_sui").prop("disabled", true).text("Refreshing Social User Info...");
      location.href="@com.keepit.controllers.admin.routes.AdminUserController.refreshAllSocialInfo(user.id.get)"
    }
    function impersonate() {
      $.post("@com.keepit.controllers.admin.routes.AdminAuthController.impersonate(user.id.get)")
    }
    function unimpersonate() {
      $.post("@com.keepit.controllers.admin.routes.AdminAuthController.unimpersonate()")
    }
    function configSearch() {
      location.href="@com.keepit.controllers.admin.routes.AdminSearchConfigController.showUserConfig(user.id.get)"
    }
    $(function() {
      $('.table').on('click', 'div.collections', function () {
        var $input = $('<input type="text">').addClass('collections').val($(this).text());
        $(this).hide().parent().append($input);
        $input.focus();
      });
      $('.table').on('keydown', 'input.collections', function (e) {
        if (e.keyCode === 13) {
          e.preventDefault();
          $(this).blur();
        }
      });
      $('.table').on('change', 'input.collections', function () {
        var $div = $(this).parent().find('div.collections');
        var $td = $div.closest("td");
        var $sp = $("<img src='/assets/images/spinner.15.gif'>").appendTo($td);
        var bookmarkId = $div.data("id");
        $.post('@com.keepit.controllers.admin.routes.AdminUserController.updateCollectionsForBookmark(Id(-1))'
            .replace('-1', bookmarkId), { collections: $(this).val() }).done(done).fail(fail);
        function done(data) {
          $div.text(data.collections.join(", ")).show();
          $sp.after($("<i class=icon-ok-sign>").delay(1000).fadeOut()).remove();
        }
        function fail() {
          $sp.after($("<i class=icon-exclamation-sign></i> Error. Reload?").delay(3000).fadeOut()).remove();
        }
        return false;
      });
      $('.table').on('blur', 'input.collections', function () {
        $(this).parent().find('.collections').show();
        $(this).remove();
      });
      $("#state").change(function() {
        var $td = $(this).closest("td");
        var $sp = $("<img src=/assets/images/spinner.15.gif>").appendTo($td);
          $.post('@com.keepit.controllers.admin.routes.AdminUserController.changeState(user.id.get, "____")'.replace("____", $(this).val()))
            .done(function () {
              $sp.after($("<i class=icon-ok-sign>").delay(1000).fadeOut()).remove();
            });
      });

      $("#experiments").on("click", "input", function() {
        var $td = $(this).closest("#experiments");
        var $sp = $("<img src=/assets/images/spinner.15.gif>").appendTo($td);
        if (this.checked) {
          console.log($(this).data("exp"))
          $.post('@com.keepit.controllers.admin.routes.AdminUserController.addExperiment(user.id.get, "____")'.replace("____", $(this).data("exp")))
            .done(done).fail(fail);
        } else {
          $.ajax('@com.keepit.controllers.admin.routes.AdminUserController.removeExperiment(user.id.get, "____")'.replace("____", $(this).data("exp")),
            {type: "DELETE"}).done(done).fail(fail);
        }
        function done() {
          $sp.after($("<i class=icon-ok-sign>").delay(1000).fadeOut()).remove();
        }
        function fail() {
          $sp.after($("<i class=icon-exclamation-sign></i> Error. Reload?").delay(3000).fadeOut()).remove();
        }
      });
    });
  </script>
}
