@(data: String, name: String, mode: String="simple", display: String="seperate", masterTitle : String = "[merged]")
<div id="chart_container_@name"></div>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.2.1/lodash.min.js"></script>
<!-- <script type="text/javascript" src="http://code.jquery.com/jquery-2.0.3.min.js"></script> -->
<script type="text/javascript" src="https://www.google.com/jsapi"></script>

<script type="text/javascript">
  (function(name, rawData, options){
    window.chartData = window.chartData || {}
    chartData[name] = rawData;

    //data error checking
    if (rawData.length===0){
      console.log("Error: Can't render zero charts.")
      return;
    }; 
    google.load('visualization', '1.0', {'packages':['corechart']});

    function discoverKeys(rawData, legend){
      var keys = {}
      rawData.forEach(function(datum){
        datum.data.forEach(function(kv){
          var new_key = legend['' + kv._id] || kv._id;
          keys[new_key] = true;
        });
      });
      return _.keys(keys);
    };

    function objectify(rawData, legend){
      rawData.forEach(function(datum){
        var newData = {};
        datum.data.forEach(function(kv){
          var new_key = legend['' + kv._id] || kv._id;
          newData[new_key] = kv.count;
        });
        datum.data = newData; 
      });
    };

    function addTotal(metric){
      _.forEach(metric.data, function(frame){
        var total = 0;
        _.forEach(frame.data, function(subtotal){
          total += subtotal;
        });
        frame.data.total=total;
      });
    };

    function summify(metric){
      var sum = {};
      _.forEach(metric.data, function(frame){
        _.forEach(metric.keys, function(key){
          sum[key] = (sum[key] || 0) + (frame.data[key] || 0);
          frame.data[key] = Math.round(sum[key]/(metric.resolution || 1)) + (metric.shift[key] || 0);
        });
      });
    };

    function merge(metrics){ //Warning, the metrics here have to have the same start, window and step
      var merged = {};
      merged.header = options.header;
      merged.data = [];
      var keys = {};
      var numFrames = metrics[0].data.length;
      for (var i=0; i<numFrames; i++){
        var newFrame = {time: metrics[0].data[i].time, data: {}}
        _.forEach(metrics, function(metric){
          _.forEach(metric.data[i].data, function(value, key){
            newFrame.data[key] = value;
            keys[key] = true;
          });
        });
        merged.data.push(newFrame);
      };
      merged.keys = _.keys(keys);
      return merged;
    }

    function preprocess(metric){
      var metricKeys = discoverKeys(metric.data, metric.legend)
      if (metricKeys.length===0){
        metricKeys.push(datum.legend['null'] || 'null'); 
      }
      metric.keys = metricKeys; 
      objectify(metric.data, metric.legend);
      if (metric.keys.length>1 && metric.totalable){
        addTotal(metric);
        metric.keys.push("total"); 
      };
      if (options.sum){
        summify(metric);
      };
    };

    function prepareDom(metric){
      var chartParent = $("#chart_container_" + name);
      chartParent.append($('<div>', {id: name + metric.header, style:"width: 100%; height:400px;", text: "Rendering chart. Hold tight!"}));
    }; 

    function drawAndRedraw(){
      drawChart();
      window.onresize = function(){
        drawChart();
      }
    };

    function drawChart(){
      _.forEach(rawData, function(metric){
        var data = new google.visualization.DataTable();
        data.addColumn("datetime")
        metric.keys.forEach(function(key){
          if (key==="null"){
            if (metric.keys.length===1){
              data.addColumn('number', "Count");
            } else {
              data.addColumn('number', "[Group Field Missing]");
            }
          } else {
            data.addColumn('number', key);
          }
        });
        metric.data.forEach(function(frame){
          var row = [];
          row.push(new Date(frame.time));
          metric.keys.forEach(function(key){
            row.push(frame.data[key] || 0);
          });
          data.addRow(row);
        });

        var suffix = "";
        if (options.sum) {
          suffix = " (CUMMULATIVE)";
        }

        var chart = new google.visualization.LineChart(document.getElementById(name + metric.header));
        chart.draw(data, {'title': metric.header + suffix});
      });
    };


    _.forEach(rawData, function(metric){preprocess(metric)});
    
    if (options.merge){
      rawData = [merge(rawData)];
    }

    _.forEach(rawData, function(metric){prepareDom(metric)});

    google.setOnLoadCallback(drawAndRedraw);


  })(
    "@name",
    @Html(data),
    {
      sum    : ("@mode"==="sum"),
      merge  : ("@display"==="merged"),
      header : "@masterTitle"
    }
  );

  
</script>
