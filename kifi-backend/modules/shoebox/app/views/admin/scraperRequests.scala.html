@(assigned:Seq[ScrapeInfo], overdue:Seq[ScrapeInfo], assignedCount:Int, overdueCount:Int, threadInstanceInfoSeq:Seq[com.keepit.scraper.ScraperThreadInstanceInfo])(implicit flash: Flash)

@import com.keepit.controllers.admin.routes
@import com.keepit.common.amazon.AmazonInstanceInfo

@instanceTitle(instanceInfo: AmazonInstanceInfo) = {
    @instanceInfo.name match {
        case Some(name) => {@name}
        case None => {@instanceInfo.instanceId.toString (anonymous instance)}
    }
}

@titleHint(id: String, availableCount: Int, count: Int) = {
    <span class="@id">
        @defining(if (count == 1) "result" else "results") { result =>
            @if(availableCount >= count) {
                <span>(@availableCount @result)</span>
            } else {
                <span>(showing @availableCount out of @count @result)</span>
            }
        }
    </span>
}

@requestTable(id: String, requests:Seq[ScrapeInfo], assigned: Boolean) = {
    <div class="@id">
        <table class="table table-condensed table-striped" style="table-layout:fixed;word-wrap:break-word;">
            <tr>
                <th class="span1">Id</th>
                <th class="span1">uriId</th>
                <th class="span1">lastScrape</th>
                <th class="span1">nextScrape</th>
                <th class="span1">interval</th>
                <th class="span1">failures</th>
                @if(assigned) {
                    <th class="span1">workerId</th>
                } else {
                    <th class="span1">state</th>
                }
                <th class="span1">signature</th>
                <th class="span4">destUrl</th>
            </tr>
            @for(info <- requests) {
            <tr>
                <td>@info.id</td>
                <td><a href="@com.keepit.controllers.admin.routes.AdminBookmarksController.editFirstBookmarkForUri(info.uriId)">@info.uriId</a></td>
                <td>@adminHelper.dateTimeDisplay(info.lastScrape)</td>
                <td>@adminHelper.dateTimeDisplay(info.nextScrape)</td>
                <td>@info.interval</td>
                <td>@info.failures</td>
                @if(assigned) {
                    <td>@info.workerId.getOrElse("-")</td>
                } else {
                    <td>@info.state</td>
                }
                <td>@info.signature.take(20)</td>
                <td><a href="@info.destinationUrl">@info.destinationUrl</a></td>
            </tr>
            }
        </table>
    </div>
}

<div>
    @titleHint("assigned-title-hint", assigned.length, assignedCount)

    @requestTable("assigned-request-table", assigned, true)

    @titleHint("overdue-title-hint", overdue.length, overdueCount)

    @requestTable("overdue-request-table", overdue, false)


    <span class="thread-details-hint">(@threadInstanceInfoSeq.length @if(threadInstanceInfoSeq.length == 1) {instance} else {instances})</span>

    <div class="thread-details">
        <div style="margin-bottom:10px;overflow:hidden">
            @for(threadInstanceInfo <- threadInstanceInfoSeq) {
                @adminHelper.instanceInfoModal(threadInstanceInfo.info.instanceId.toString, threadInstanceInfo.info)
                <div class="well" style="background-color:#efefef;margin-bottom:10px;">
                    <div style="margin-bottom:10px;overflow:hidden;">
                        <div style="float:left"><h4 style="padding:0;margin:0">@instanceTitle(threadInstanceInfo.info)</h4></div>
                        <div style="float:right"><button type="button" data-toggle="modal" data-target="#@threadInstanceInfo.info.instanceId.toString">Show Info</button></div>
                    </div>
                    @if(!threadInstanceInfo.scrapeThreadDetails.isEmpty) {
                        <h5>Scrape Threads</h5>
                        <table class="table table-condensed table-bordered" style="padding:0;margin:0;table-layout:fixed;word-wrap:break-word;">
                            <thead>
                                <tr>
                                    <th class="span2">Thread ID</th>
                                    <th class="span1">Submitted</th>
                                    <th class="span1">Called</th>
                                    <th class="span1">Kill Count</th>
                                    <th class="span1">URI ID</th>
                                    <th class="span1">Scrape ID</th>
                                    <th class="span2">URL</th>
                                    <th class="span2">State</th>
                                    <th class="span1">Share</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for(details <- threadInstanceInfo.scrapeThreadDetails) {
                                    @details.description match {
                                        case Left(task) => {
                                            <tr>
                                                <td>@task.name</td>
                                                <td>@adminHelper.timeDisplay(task.submitDateTime)</td>
                                                <td>@task.callDateTime.map(ts => adminHelper.timeDisplay(ts))</td>
                                                <td>@task.killCount.getOrElse(0)</td>
                                                <td>@task.uriId.getOrElse("-")</td>
                                                <td>@task.scrapeId.getOrElse("-")</td>
                                                <td>@task.url</td>
                                                <td>@details.state.getOrElse("-")</td>
                                                <td>@details.share.getOrElse("-")</td>
                                            </tr>
                                        }
                                        case _ => {}
                                    }
                                }
                            </tbody>
                        </table>
                    } else {
                        <h5>No scrape tasks</h5>
                    }
                    @if(!threadInstanceInfo.fetchBasicThreadDetails.isEmpty) {
                        <h5>Fetch Threads</h5>
                        <table class="table table-condensed table-bordered" style="padding:0;margin:0;table-layout:fixed;word-wrap:break-word;">
                            <thead>
                                <tr>
                                    <th class="span2">Thread ID</th>
                                    <th class="span1">Submitted</th>
                                    <th class="span1">Called</th>
                                    <th class="span2">URL</th>
                                    <th class="span2">Extractor</th>
                                    <th class="span2">State</th>
                                    <th class="span1">Share</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for(details <- threadInstanceInfo.fetchBasicThreadDetails) {
                                    @details.description match {
                                        case Left(task) => {
                                            <tr>
                                                <td>@task.name</td>
                                                <td>@adminHelper.timeDisplay(task.submitDateTime)</td>
                                                <td>@task.callDateTime.map(ts => adminHelper.timeDisplay(ts))</td>
                                                <td>@task.url</td>
                                                <td>@task.extractor.getOrElse("-")</td>
                                                <td>@details.state.getOrElse("-")</td>
                                                <td>@details.share.getOrElse("-")</td>
                                            </tr>
                                        }
                                        case _ => {}
                                    }
                                }
                            </tbody>
                        </table>
                    } else {
                        <h5>No fetch tasks</h5>
                    }
                    @if(!threadInstanceInfo.otherThreadDetails.isEmpty) {
                        <h5>Other Threads</h5>
                        <table class="table table-condensed table-bordered" style="padding:0;margin:0;table-layout:fixed;word-wrap:break-word;">
                            <thead>
                                <tr>
                                    <th class="span9">Thread Id</th>
                                    <th class="span2">State</th>
                                    <th class="span1">Share</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for(details <- threadInstanceInfo.otherThreadDetails) {
                                    @details.description match {
                                        case Right(description) => {
                                            <tr>
                                                <td>@description</td>
                                                <td>@details.state.getOrElse("-")</td>
                                                <td>@details.share.getOrElse("-")</td>
                                            </tr>
                                        }
                                        case _ => {}
                                    }
                                }
                            </tbody>
                        </table>
                    }
                </div>
            }
        </div>
    </div>
</div>